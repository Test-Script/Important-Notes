================= SonarQube Configuration & Deployment on the ubuntu linux with Docker ===================

Initially I was facing the difficulties with the Installation & Configuration on the linux serve directly.

Following Issues I was went through

1. Database Ownership, Permissions & Roles Assignmnet
2. Version Conflit between SonarQube & PostgreSQL

The Things I was tried

1. Assign the right ownership to sonarqube database, With relavent permssions.
2. Upgraded the Version of SonarQube which is compatible with the PostgreSQL. (By taking the backup of the server & Postgresql Database : For the wrost case scenarios).

By using this I was able to fixed this issues.

Later On I was figured-out Instead of going with direct server installation, It's better to go with Docker Container Option which is not that complex. We can manage it very efficiently.

=================================== Step to follow the SonarQube With Docker =============================

1. Prerequisites

OS            : Linux (Ubuntu/RHEL/CentOS preferred)
RAM           : Minimum 4 GB (8 GB recommended)
CPU           : 2 vCPU+
Disk          : 10–15 GB free

Docker        : >= 20.x
Docker Compose: >= v2

docker --version
docker compose version

2. Mandatory Kernel Configuration (Very Important)

SonarQube uses Elasticsearch internally and will not start unless this is set.

sudo sysctl -w vm.max_map_count=262144

Persist after reboot:

echo "vm.max_map_count=262144" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

Verify:

sysctl vm.max_map_count

3. Directory Structure (Recommended)

sonarqube-docker/
├── docker-compose.yml
├── data/
├── logs/
└── extensions/

Create directories:

mkdir -p sonarqube-docker/{data,logs,extensions}
cd sonarqube-docker

4. Docker Compose File (PostgreSQL + SonarQube)

version: "3.9"

services:
  postgres:
    image: postgres:15
    container_name: sonarqube-postgres
    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
      POSTGRES_DB: sonarqube
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  sonarqube:
    image: sonarqube:lts-community
    container_name: sonarqube
    depends_on:
      - postgres
    ports:
      - "9000:9000"
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://postgres:5432/sonarqube
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
    volumes:
      - ./data:/opt/sonarqube/data
      - ./logs:/opt/sonarqube/logs
      - ./extensions:/opt/sonarqube/extensions
    restart: unless-stopped

volumes:
  postgres_data:

5. Start SonarQube

docker compose up -d

Check containers:

docker ps

6. Monitor Startup Logs (Critical for First Run)

docker logs -f sonarqube

Wait until you see:

SonarQube is up

Initial startup may take 2–5 minutes.

7. Access SonarQube Web UI

URL      : http://<server-ip>:9000
Username : admin
Password : admin

You will be prompted to change the password immediately.

8. Common Issues & Fixes

Issue: Web UI not responding

docker logs sonarqube

Check:

vm.max_map_count

Available RAM

PostgreSQL container status

Issue: Elasticsearch bootstrap error

ERROR: bootstrap checks failed

Fix:

sysctl vm.max_map_count

Must be 262144.

Issue: Permission denied on volumes

sudo chown -R 1000:1000 data logs extensions

Restart:

docker compose restart

9. Stop / Restart / Remove

docker compose stop

docker compose restart

Remove everything (Clean Setup)

docker compose down -v
rm -rf data logs extensions

10. Recommended Production Enhancements

• Use NGINX reverse proxy (HTTPS)
• Use external managed PostgreSQL
• Enable backup for volumes
• Configure LDAP / SSO
• Add resource limits in docker-compose

11. Version Upgrade Strategy

1. Backup volumes
2. Update image tag
3. docker compose pull
4. docker compose up -d


============================== Advance Configuration With Nginx + SSL ====================================

![Image](https://miro.medium.com/1%2AteKlU8ITI81QWRHnqUETfg.png)

![Image](https://www.f5.com/_next/image?q=75\&url=https%3A%2F%2Fcdn.studio.f5.com%2Fimages%2Fk6fem79d%2Fproduction%2F5cafef58ff7bd938f1bd996ddebab2d4960e215b-1024x572.png\&w=1600)

![Image](https://assets.digitalocean.com/articles/letsencrypt/nginx-letsencrypt.png)

![Image](https://europe1.discourse-cdn.com/sonarsource/uploads/sonarcommunity/original/3X/e/c/eca3e0d53827af1ba52bddd50e2937aac82510d9.png)

Below is a **production-grade, step-by-step guide** to configure **SonarQube** behind **NGINX** with **HTTPS (SSL)** using **Let's Encrypt**.

This setup is **industry standard** and suitable for CI/CD integrations.

---

## Architecture Overview

```
Browser (HTTPS 443)
        |
        v
NGINX (SSL Termination)
        |
        v
SonarQube (Docker :9000)
```

---

## 1. Prerequisites

### Mandatory

```
• SonarQube running on Docker (port 9000)
• Public DNS (sonarqube.example.com)
• Server with public IP
• Ports open: 80, 443
```

### Verify SonarQube

```
http://<server-ip>:9000   → SonarQube UI accessible
```

---

## 2. Install NGINX

### Ubuntu / Debian

```
sudo apt update
sudo apt install -y nginx
```

### RHEL / CentOS / Rocky

```
sudo dnf install -y nginx
```

Enable & start:

```
sudo systemctl enable nginx
sudo systemctl start nginx
```

Verify:

```
http://<server-ip>
```

---

## 3. DNS Configuration (Mandatory)

Create an **A record**:

```
sonarqube.example.com  →  <SERVER_PUBLIC_IP>
```

Validate:

```
ping sonarqube.example.com
```

---

## 4. NGINX Reverse Proxy Configuration

Create config file:

```
sudo vi /etc/nginx/conf.d/sonarqube.conf
```

### HTTP Configuration (Temporary – for SSL issuance)

```
server {
    listen 80;
    server_name sonarqube.example.com;

    location / {
        proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
    }
}
```

Test & reload:

```
sudo nginx -t
sudo systemctl reload nginx
```

Test:

```
http://sonarqube.example.com
```

---

## 5. Install Certbot (Let’s Encrypt)

### Ubuntu

```
sudo apt install -y certbot python3-certbot-nginx
```

### RHEL

```
sudo dnf install -y certbot python3-certbot-nginx
```

---

## 6. Generate SSL Certificate

```
sudo certbot --nginx -d sonarqube.example.com
```

Choose:

```
✔ Redirect HTTP to HTTPS
✔ Provide email
✔ Agree to TOS
```

Certificates created at:

```
/etc/letsencrypt/live/sonarqube.example.com/
```

---

## 7. Final NGINX HTTPS Configuration (Hardened)

Certbot auto-updates the config. Final version should look like this:

```
server {
    listen 443 ssl;
    server_name sonarqube.example.com;

    ssl_certificate /etc/letsencrypt/live/sonarqube.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sonarqube.example.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}
```

Reload:

```
sudo nginx -t
sudo systemctl reload nginx
```

---

## 8. Configure SonarQube for Reverse Proxy

### Update SonarQube Docker Compose

Edit `docker-compose.yml`:

```
environment:
  SONAR_WEB_HOST: 0.0.0.0
  SONAR_WEB_PORT: 9000
  SONAR_WEB_CONTEXT: /
```

Restart:

```
docker compose restart sonarqube
```

---

## 9. Update SonarQube Base URL (Mandatory)

Login as admin:

```
Administration → Configuration → General
```

Set:

```
Server base URL = https://sonarqube.example.com
```

This is **critical** for:

```
• Webhooks
• CI/CD integrations
• OAuth
```

---

## 10. Enable Auto-Renewal (Let’s Encrypt)

Test renewal:

```
sudo certbot renew --dry-run
```

Systemd timer (default):

```
systemctl list-timers | grep certbot
```

---

## 11. Security Hardening (Recommended)

```
• Disable port 9000 from public firewall
• Allow only 127.0.0.1 → 9000
• Enable fail2ban
• Add rate limiting in NGINX
```

Firewall example:

```
sudo ufw allow 80
sudo ufw allow 443
sudo ufw deny 9000
```

---

## 12. Validation Checklist

```
✔ https://sonarqube.example.com loads
✔ SSL padlock visible
✔ Admin → Base URL correct
✔ CI pipelines connect without errors
```

---

## Optional Enhancements (Tell me if needed)

```
• NGINX Basic Auth / LDAP
• Wildcard SSL
• HAProxy instead of NGINX
• AWS ALB / Azure App Gateway
• SonarQube behind VPN
• Zero-trust access
```

If you share:

```
• OS type
• Cloud (AWS / Azure / On-Prem)
• Domain availability
```

I will tailor this into an **enterprise-grade hardened configuration**.

========================= Enterprise-Grade Hardened Configuration ========================================

![Image](https://scm.thm.de/sonar/images/embed-doc/images/architecture-integrate.png)

![Image](https://miro.medium.com/1%2AwaXTjT6GKx8mXkAXN4_zMA.png)

![Image](https://miro.medium.com/0%2AQxK2nKgMTn9XXwak.jpeg)

![Image](https://www.f5.com/_next/image?q=75\&url=https%3A%2F%2Fcdn.studio.f5.com%2Fimages%2Fk6fem79d%2Fproduction%2F5cafef58ff7bd938f1bd996ddebab2d4960e215b-1024x572.png\&w=1600)

Below is a **fully hardened, enterprise-grade SonarQube deployment blueprint** using **NGINX + SSL**, aligned with **security, reliability, and compliance best practices**.
This is suitable for **corporate networks, audits, and CI/CD at scale**.

---

## 1. Enterprise Architecture (Target State)

```
Users / CI Pipelines
        |
        v
[ NGINX (TLS 1.2/1.3, WAF, Rate Limit) ]
        |
        v
[ SonarQube (Docker, Non-root, Internal Port) ]
        |
        v
[ PostgreSQL (Isolated Network, Backup Enabled) ]
```

---

## 2. Network & Firewall Hardening (Mandatory)

### Exposure Rules

```
• Public: 443 (HTTPS)
• Internal Only: 9000 (SonarQube)
• DB Network: PostgreSQL not publicly reachable
```

### Linux Firewall (UFW example)

```
ufw allow 443/tcp
ufw allow from 127.0.0.1 to any port 9000
ufw deny 9000
ufw enable
```

---

## 3. NGINX – Enterprise Hardened Configuration

### `/etc/nginx/conf.d/sonarqube.conf`

```
limit_req_zone $binary_remote_addr zone=sonar_limit:10m rate=10r/s;

server {
    listen 443 ssl http2;
    server_name sonarqube.example.com;

    ssl_certificate /etc/letsencrypt/live/sonarqube.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sonarqube.example.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers EECDH+AESGCM:EDH+AESGCM;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy no-referrer;
    add_header Content-Security-Policy "default-src 'self'";

    limit_req zone=sonar_limit burst=20 nodelay;

    location / {
        proxy_pass http://127.0.0.1:9000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }
}
```

Validate:

```
nginx -t && systemctl reload nginx
```

---

## 4. Docker Security Hardening (Critical)

### Docker Compose (Hardened)

```
services:
  sonarqube:
    image: sonarqube:lts-community
    user: "1000:1000"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    ports:
      - "127.0.0.1:9000:9000"
```

Key Controls:

```
• Non-root container
• No Linux capabilities
• No privilege escalation
• Localhost-only exposure
```

---

## 5. SonarQube Internal Hardening

### Administration → Security

```
✔ Disable anonymous access
✔ Enforce strong password policy
✔ Rotate admin credentials
✔ Create service account for CI
```

### Tokens

```
• Use project-level tokens
• Set expiry dates
• Rotate quarterly
```

---

## 6. Authentication & Access Control (Enterprise)

### Preferred Options

```
• LDAP / Active Directory
• Azure AD / SAML / OAuth2
```

Benefits:

```
• Centralized identity
• Immediate access revocation
• Audit-ready
```

---

## 7. Logging, Monitoring & Audit

### Enable Log Persistence

```
/opt/sonarqube/logs
```

### Integrations

```
• Forward NGINX logs → SIEM
• Monitor JVM metrics
• Alert on:
   - Login failures
   - Disk usage
   - DB latency
```

---

## 8. Backup & Disaster Recovery (Non-Negotiable)

### Backup Scope

```
• PostgreSQL database
• SonarQube volumes (data + extensions)
```

### Strategy

```
• Daily automated backups
• 7–30 day retention
• Quarterly restore test
```

---

## 9. CI/CD Secure Integration

### Best Practices

```
• Never hardcode tokens
• Use pipeline secrets
• Restrict tokens per project
• Enforce Quality Gates
```

---

## 10. Compliance & Governance Alignment

This setup supports:

```
✔ ISO 27001
✔ SOC 2
✔ PCI-DSS (internal tools)
✔ Enterprise SDLC governance
```

---

## 11. Operational Runbook (Summary)

```
• SSL auto-renew verified
• Docker image pinned to LTS
• Monthly patching window
• Quarterly access review
• Annual DR drill
```

---

## 12. Final Validation Checklist

```
✔ Port 9000 not exposed
✔ HTTPS enforced
✔ Security headers enabled
✔ CI pipelines functional
✔ Backups verified
```

---

### If you want, I can additionally provide:

```
• Azure Application Gateway / AWS ALB version
• Zero Trust (VPN / Private Endpoint)
• HA SonarQube (Data Center Edition)
• Terraform + Ansible automation
• Compliance documentation pack
```

State the **deployment environment** (Azure / AWS / On-Prem), and I will convert this into a **ready-to-execute enterprise implementation**.

==========================================================================================================