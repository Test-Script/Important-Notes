#### Architecture - Access Vault Secret Via VM

### Script to Create Complete Azure Infra for Access the Credentials from the Azure Key Vault in your code

Subscription : Test

Region : Central India

1. RESOURCE GROUP

# Varify the location Currently Enabled for the Subscription

az account list-locations --query "[?contains(displayName, 'India')]" -o table

tejas [ ~ ]$ az account list-locations --query "[?contains(displayName, 'India')]" -o table
DisplayName        Name             RegionalDisplayName
-----------------  ---------------  --------------------------------
Central India      centralindia     (Asia Pacific) Central India
India              india            India
Jio India West     jioindiawest     (Asia Pacific) Jio India West
Jio India Central  jioindiacentral  (Asia Pacific) Jio India Central
South India        southindia       (Asia Pacific) South India
West India         westindia        (Asia Pacific) West India

# Define variables :

RESOURCE_GROUP="rg-identity-test"
LOCATION="centralindia"

# Create Resource Group :

az group create \
  --name $RESOURCE_GROUP \
  --location $LOCATION

2. MANAGED IDENTITY

az login

az account show --output table

az account set --subscription "52f167e5-dfca-4d77-a744-e6c7bc1a3235"

# Define variables :

RESOURCE_GROUP="rg-identity-test"
LOCATION="centralindia"
IDENTITY_NAME="test_identity"

# Create User-Assigned Managed Identity :

az identity create \
  --name $IDENTITY_NAME \
  --resource-group $RESOURCE_GROUP \
  --location $LOCATION

# Verify Identity: 

az identity show \
  --name $IDENTITY_NAME \
  --resource-group $RESOURCE_GROUP

PRINCIPAL_ID=$(az identity show \
  --name $IDENTITY_NAME \
  --resource-group $RESOURCE_GROUP \
  --query principalId \
  --output tsv)

# Assign the Role to Identity

az role assignment create \
  --assignee <PRINCIPAL_ID> \
  --role "Storage Blob Data Reader" \
  --scope /subscriptions/52f167e5-dfca-4d77-a744-e6c7bc1a3235/resourceGroups/<RG_NAME>/providers/Microsoft.Storage/storageAccounts/<STORAGE_ACCOUNT_NAME>

3. AZURE KEY VAULT

# Variables (Always Do This First)

RESOURCE_GROUP="rg-security-test"
LOCATION="centralindia"
KEYVAULT_NAME="kv-tt-app-test-001"
IDENTITY_NAME="test_identity"
SUBSCRIPTION_ID="52f167e5-dfca-4d77-a744-e6c7bc1a3235"

# Create Resource Group

az group create \
  --name $RESOURCE_GROUP \
  --location $LOCATION

# Create Azure Key Vault (RBAC Enabled – Recommended)

az keyvault create \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --location $LOCATION \
  --enable-rbac-authorization true

# Assign Key Vault RBAC Permissions

  # Read Secrets Only (Most Common)

  az role assignment create \
  --assignee $PRINCIPAL_ID \
  --role "Key Vault Secrets User" \
  --scope /subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$KEYVAULT_NAME

| Role                      | Purpose               |
| ------------------------- | --------------------- |
| Key Vault Secrets User    | Read secrets          |
| Key Vault Secrets Officer | Create/update secrets |
| Key Vault Administrator   | Full control          |
| Key Vault Crypto User     | Use encryption keys   |

# Create a Secret

az keyvault secret set \
  --vault-name $KEYVAULT_NAME \
  --name "" \
  --value ""

# Read a Secret (CLI – For Testing)

az keyvault secret show \
  --vault-name $KEYVAULT_NAME \
  --name "DbPassword" \
  --query value \
  --output tsv

# Enable Key Vault Firewall (Optional but Recommended)

Allow Trusted Azure Services

az keyvault update \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --bypass AzureServices \
  --default-action Deny

Allow Specific IP

az keyvault network-rule add \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --ip-address 203.0.113.10

Soft Delete & Purge Protection (Critical for Production)

az keyvault update \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --enable-soft-delete true \
  --enable-purge-protection true

## Common Real-World Integrations (Most Important)

  VM → Key Vault (Managed Identity)

  App Service → Key Vault references

  Azure Functions → Secrets

  Azure DevOps → Variable groups

  AKS → CSI Secrets Store

# Security Best Practices (Important)

  Always use RBAC, not access policies

  Never store secrets in code or pipelines

  Use Managed Identity only

  Enable purge protection

  Use separate Key Vaults per environment (dev/test/prod)

  Rotate secrets regularly

4. AZURE VNET + TWO SUBNETS

# Define Variables (Mandatory)

SUBSCRIPTION_ID="52f167e5-dfca-4d77-a744-e6c7bc1a3235"
RESOURCE_GROUP="rg-network-security-test"
LOCATION="centralindia"

VNET_NAME="vnet-app-test"
VNET_CIDR="10.10.0.0/16"

SUBNET1_NAME="subnet-vm"
SUBNET1_CIDR="10.10.1.0/24"

SUBNET2_NAME="subnet-service"
SUBNET2_CIDR="10.10.2.0/24"

KEYVAULT_NAME="kv-tt-app-test-001"

# Create Resource Group

az group create \
  --name $RESOURCE_GROUP \
  --location $LOCATION

# Create Virtual Network with First Subnet

az network vnet create \
  --resource-group $RESOURCE_GROUP \
  --name $VNET_NAME \
  --address-prefix $VNET_CIDR \
  --subnet-name $SUBNET1_NAME \
  --subnet-prefix $SUBNET1_CIDR \
  --location $LOCATION

# Create Second Subnet

az network vnet subnet create \
  --resource-group $RESOURCE_GROUP \
  --vnet-name $VNET_NAME \
  --name $SUBNET2_NAME \
  --address-prefix $SUBNET2_CIDR

# Verify VNet and Subnets

az network vnet subnet list \
  --resource-group $RESOURCE_GROUP \
  --vnet-name $VNET_NAME \
  --output table

# Option (Not Required)

Allow VNet Subnets to Access Key Vault

- Allow Subnet-1

az keyvault network-rule add \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --vnet-name $VNET_NAME \
  --subnet $SUBNET1_NAME

- Allow Subnet-2

az keyvault network-rule add \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --vnet-name $VNET_NAME \
  --subnet $SUBNET2_NAME

- Validate Key Vault Network Rules

az keyvault network-rule list \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP

5. Private Endpoint for the Azure Key Vault

# Define Variables (MANDATORY)

SUBSCRIPTION_ID="52f167e5-dfca-4d77-a744-e6c7bc1a3235"
RESOURCE_GROUP="rg-network-security-test"
LOCATION="centralindia"

VNET_NAME="vnet-app-test"
SUBNET_NAME="subnet-service"

KEYVAULT_NAME="kv-tt-app-test-001"

PRIVATE_ENDPOINT_NAME="pe-kv-app-prod"
PRIVATE_DNS_ZONE="privatelink.vaultcore.azure.net"
DNS_LINK_NAME="dnslink-kv-prod"

# Get Key Vault Resource ID

RESOURCE_GROUP="rg-security-test"

KV_RESOURCE_ID=$(az keyvault show \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --query id \
  --output tsv)

# Create Private Endpoint

RESOURCE_GROUP="rg-network-security-test"

az network private-endpoint create \
  --name $PRIVATE_ENDPOINT_NAME \
  --resource-group $RESOURCE_GROUP \
  --location $LOCATION \
  --vnet-name $VNET_NAME \
  --subnet $SUBNET_NAME \
  --private-connection-resource-id $KV_RESOURCE_ID \
  --group-id vault \
  --connection-name "kv-private-connection"

# Create Private DNS Zone (Required)

az network private-dns zone create \
  --resource-group $RESOURCE_GROUP \
  --name $PRIVATE_DNS_ZONE

# Link Private DNS Zone to VNet

az network private-dns link vnet create \
  --resource-group $RESOURCE_GROUP \
  --zone-name $PRIVATE_DNS_ZONE \
  --name $DNS_LINK_NAME \
  --virtual-network $VNET_NAME \
  --registration-enabled false

# Create DNS Zone Group for Private Endpoint

This step connects the Private Endpoint to DNS.

az network private-endpoint dns-zone-group create \
  --resource-group $RESOURCE_GROUP \
  --endpoint-name $PRIVATE_ENDPOINT_NAME \
  --name "kv-dns-zone-group" \
  --private-dns-zone $PRIVATE_DNS_ZONE \
  --zone-name "kvZone"

# Validate Private Endpoint

az network private-endpoint show \
  --name $PRIVATE_ENDPOINT_NAME \
  --resource-group $RESOURCE_GROUP \
  --query "privateLinkServiceConnections[].privateLinkServiceConnectionState.status"

Expected output: Approved

# Validate DNS Resolution (From VM in VNet)

nslookup $KEYVAULT_NAME.vault.azure.net

# Lock Down Key Vault Public Access (CRITICAL)

RESOURCE_GROUP="rg-security-test"
KEYVAULT_NAME="kv-tt-app-test-001"

az keyvault update \
  --name $KEYVAULT_NAME \
  --resource-group $RESOURCE_GROUP \
  --public-network-access Disabled

6. AZURE VIRTUAL MACHINE – AZ CLI (LINUX VM)

Azure Virtual Machines provide on-demand compute with:

  Full OS control

  VNet integration

  Managed Identity support

  Secure access to Key Vault via Private Endpoint

# Define Variables (MANDATORY)

SUBSCRIPTION_ID="52f167e5-dfca-4d77-a744-e6c7bc1a3235"
RESOURCE_GROUP="rg-vm-test"
LOCATION="centralindia"

VM_NAME="vm-app-test-01"
VM_SIZE="Standard_B2s"

VNET_NAME="vnet-app-test"
SUBNET_NAME="subnet-vm"

NIC_NAME="nic-vm-app-test-01"
NSG_NAME="nsg-vm-app-test"

ADMIN_USERNAME="azureuser"
ADMIN_PASSWORD=""

# Create Resource Group :

az group create \
  --name $RESOURCE_GROUP \
  --location $LOCATION

# Create Network Security Group (NSG)

az network nsg create \
  --resource-group $RESOURCE_GROUP \
  --name $NSG_NAME \
  --location $LOCATION

# Allow SSH (Restrict IP in Production)

az network nsg rule create \
  --resource-group $RESOURCE_GROUP \
  --nsg-name $NSG_NAME \
  --name Allow-SSH \
  --priority 1000 \
  --direction Inbound \
  --access Allow \
  --protocol Tcp \
  --destination-port-range 22 \
  --source-address-prefixes 20.192.0.124

================================ Observe the Error Here ==============================

tejas [ ~ ]$ az network nic create \
  --resource-group $RESOURCE_GROUP \
  --name $NIC_NAME \
  --vnet-name $VNET_NAME \
  --subnet $SUBNET_NAME \
  --network-security-group $NSG_NAME
(InvalidResourceReference) Resource /subscriptions/52f167e5-dfca-4d77-a744-e6c7bc1a3235/resourceGroups/rg-vm-test/providers/Microsoft.Network/virtualNetworks/vnet-app-test/subnets/subnet-vm referenced by resource /subscriptions/52f167e5-dfca-4d77-a744-e6c7bc1a3235/resourceGroups/rg-vm-test/providers/Microsoft.Network/networkInterfaces/nic-vm-app-test-01 was not found. Please make sure that the referenced resource exists, and that both resources are in the same region.
Code: InvalidResourceReference
Message: Resource /subscriptions/52f167e5-dfca-4d77-a744-e6c7bc1a3235/resourceGroups/rg-vm-test/providers/Microsoft.Network/virtualNetworks/vnet-app-test/subnets/subnet-vm referenced by resource /subscriptions/52f167e5-dfca-4d77-a744-e6c7bc1a3235/resourceGroups/rg-vm-test/providers/Microsoft.Network/networkInterfaces/nic-vm-app-test-01 was not found. Please make sure that the referenced resource exists, and that both resources are in the same region.

# Verify your Variables

echo "RG: $RESOURCE_GROUP | VNet: $VNET_NAME | Subnet: $SUBNET_NAME"

# Check the Subnet Existence

az network vnet subnet list \
  --resource-group $RESOURCE_GROUP \
  --vnet-name $VNET_NAME \
  -o table

# Since your VNet lives in a different group, you have two ways to fix this.

Ah, that explains it! In Azure, a Virtual Network (VNet) is a child of the Resource Group it was created in. When you run az network nic create, the command expects to find the VNet and Subnet inside the Resource Group you provided in the --resource-group flag.

Option 1: Use the Full Resource ID (Most Reliable)
Instead of just passing the name vnet-app-test, you can pass the full Resource ID of the subnet. This tells Azure exactly where to look, regardless of which Resource Group you are currently targeting for the NIC.

# Replace 'OTHER_RG' with the actual name of the group where the VNet lives
SUB_ID=$(az network vnet subnet show \
  --resource-group OTHER_RG \
  --vnet-name vnet-app-test \
  --name subnet-vm \
  --query id -o tsv)

Then, run your create command using the ID:

az network nic create \
  --resource-group $RESOURCE_GROUP \
  --name $NIC_NAME \
  --subnet $SUB_ID \
  --network-security-group $NSG_NAME
  
Option 2: The "Cross-RG" CLI Syntax

The Azure CLI allows you to reference a subnet in a different Resource Group by using the --subnet and --vnet-name flags, but it can be finicky if the NIC itself is being created elsewhere.

The cleanest logic follows this hierarchy:

  1. The NIC will be created in $RESOURCE_GROUP.

  2. The VNet/Subnet will be referenced from OTHER_RG.

Question : Why does this happen?

Answer : Azure allows "Cross-Resource Group" references (like a NIC in RG-A connected to a VNet in RG-B), but the CLI needs the explicit path. If you only provide the name vnet-app-test, the CLI assumes it’s sitting right next to the NIC in rg-vm-test.

=======================================================================================================

# Create Network Interface (NIC)

az network nic create \
  --resource-group $RESOURCE_GROUP \
  --name $NIC_NAME \
  --vnet-name $VNET_NAME \
  --subnet $SUBNET_NAME \
  --network-security-group $NSG_NAME

# Create Virtual Machine (Ubuntu Linux)

az vm create \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --location $LOCATION \
  --nics $NIC_NAME \
  --image Ubuntu2204 \
  --size $VM_SIZE \
  --admin-username $ADMIN_USERNAME \
  --admin-password $ADMIN_PASSWORD \
  --authentication-type password \
  --assign-identity \
  --public-ip-address ""

=============================== Deletion Steps In-Case If anything went wrong =========================

# Identify the VM (Optional but Recommended)

az vm show \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --output table

# Delete ONLY the Virtual Machine (Safe Option)

az vm delete \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --yes

# Delete VM + Associated Resources (Most Common)

  Get Associated Resource Names

  OS_DISK=$(az vm show \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --query "storageProfile.osDisk.name" \
  --output tsv)

  Network Interface

  NIC_ID=$(az vm show \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --query "networkProfile.networkInterfaces[0].id" \
  --output tsv)

  NIC_NAME=$(basename $NIC_ID)

# Delete OS Disk

  az disk delete \
  --resource-group $RESOURCE_GROUP \
  --name $OS_DISK \
  --yes

# Delete Network Interface

  az network nic delete \
  --resource-group $RESOURCE_GROUP \
  --name $NIC_NAME

# (Optional) Delete Public IP (If One Exists)

  az network public-ip list \
  --resource-group $RESOURCE_GROUP \
  --output table

  az network public-ip delete \
  --resource-group $RESOURCE_GROUP \
  --name <PUBLIC_IP_NAME>

# Verify Deletion

  az vm list \
  --resource-group $RESOURCE_GROUP \
  --output table
=======================================================================================================

# Verify VM Creation

az vm show \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --output table

# Get Private IP of VM

az vm list-ip-addresses \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --query "[0].virtualMachine.network.privateIpAddresses[0]" \
  --output tsv

# Validate Managed Identity

az vm identity show \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME

7. AZURE PUBLIC IP ADDRESS – AZ CLI

SUBSCRIPTION_ID="52f167e5-dfca-4d77-a744-e6c7bc1a3235"
RESOURCE_GROUP="rg-network-security-test"
LOCATION="centralindia"

PUBLIC_IP_NAME="pip-vm-app-test-01"
DNS_LABEL="vm-app-test-01"

NOTE:

  - DNS_LABEL must be unique within the region
  - Omit DNS if not required

# Create Public IP Address (Standard + Static)

az network public-ip create \
  --resource-group $RESOURCE_GROUP \
  --name $PUBLIC_IP_NAME \
  --location $LOCATION \
  --sku Standard \
  --allocation-method Static \
  --version IPv4 \
  --dns-name $DNS_LABEL

Explanation:

  Standard → Secure by default
  Static → IP does not change
  dns-name → Optional FQDN

# Verify Public IP Creation

az network public-ip show \
  --resource-group $RESOURCE_GROUP \
  --name $PUBLIC_IP_NAME \
  --output table

Look for:

  ipAddress
  publicIpAllocationMethod: Static
  sku: Standard

# Attach Public IP to an Existing VM NIC

  RESOURCE_GROUP="rg-vm-test"

  Get NIC Name

  NIC_NAME=$(az vm show \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --query "networkProfile.networkInterfaces[0].id" \
  --output tsv | awk -F/ '{print $NF}')

  Associate Public IP with NIC

PUBLIC_IP_NAME = "/subscriptions/52f167e5-dfca-4d77-a744-e6c7bc1a3235/resourceGroups/rg-network-security-test/providers/Microsoft.Network/publicIPAddresses/pip-vm-app-test-01"

  az network nic ip-config update \
  --resource-group $RESOURCE_GROUP \
  --nic-name $NIC_NAME \
  --name ipconfig1 \
  --public-ip-address $PUBLIC_IP_NAME

  Validate Association

  az vm list-ip-addresses \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --output table

  You should now see:

  Private IP
  Public IP

======================== Error Was Observed While Trying to Connect with VM via Public Route ==========


It looks like you’ve successfully created the NIC, but now you’re hitting a "Denied" status on SSH traffic in the Network Watcher diagnostic.

The screenshot shows that your **Allow-SSH** rule (Priority 1000) is being skipped because it's **"Not matched"**. This is why the traffic falls through to the default **DenyAllInBound** rule at the bottom.

### The Problem: Source IP Mismatch

The diagnostic shows:

* **Actual Source IP:** `103.248.75.84`
* **Allow-SSH Rule:** Marked as **"Not matched"** under the Source column.

This typically means your `Allow-SSH` rule is restricted to a specific IP address or range that does **not** include `103.248.75.84`.

---

### How to Fix It via Azure CLI

To fix this, you need to update the NSG rule to allow your current public IP.

**1. Check the current rule configuration**
Run this to see what source address is currently defined:

```bash
az network nsg rule show \
  --resource-group rg-vm-test \
  --nsg-name nsg-vm-app-test \
  --name Allow-SSH

```

**2. Update the rule to allow your IP**
If you want to allow just your current machine, update the `source-address-prefixes` to match the IP in the screenshot:

```bash
az network nsg rule update \
  --resource-group rg-vm-test \
  --nsg-name nsg-vm-app-test \
  --name Allow-SSH \
  --source-address-prefixes 103.248.75.84

```

> [!IMPORTANT]
> For better security, avoid using `*` (Any) as a source. Using your specific IP (as shown in the diagnostic) is the right way to do it.

---

### Verification

After running the update, go back to the **NSG Diagnostic** in the portal and click **Recheck**. You should see:

* **Applied action:** Allowed
* **Applied rule:** Allow-SSH

===================================================Comments for Resource Deletion ===================================================

Deleting the Resources

tejas [ ~ ]$ az group list --output table
Name                      Location      Status
------------------------  ------------  ---------
rg-identity-test          centralindia  Succeeded
rg-security-test          centralindia  Succeeded
rg-network-security-test  centralindia  Succeeded
NetworkWatcherRG          centralindia  Succeeded
rg-vm-test                centralindia  Succeeded

az resource delete --ids $(az resource list --resource-group rg-identity-test --query "[].id" -o tsv)
az resource delete --ids $(az resource list --resource-group rg-security-test --query "[].id" -o tsv)
az resource delete --ids $(az resource list --resource-group rg-network-security-test --query "[].id" -o tsv)
az resource delete --ids $(az resource list --resource-group rg-vm-test --query "[].id" -o tsv)

======================================================================================================
