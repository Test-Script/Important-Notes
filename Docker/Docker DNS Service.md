============================================================================================================
                    Zones and DNS Servers within the context of Docker Network Scopes
============================================================================================================

1. DNS Zones in Docker

    DNS Zone is automatically created for every User-Defined Network (like a Bridge or Overlay network).

    # Isolation: Each network acts as its own private DNS zone. Containers on network_A cannot resolve names of containers on network_B unless they share a network.

    # Automatic Registration: When you start a container with a --name or a network-alias, Docker automatically adds an entry to that network's internal DNS zone.

    # Scope: Local Scope (Bridge): The zone exists only on that specific Docker host, and Swarm/Global Scope (Overlay): The zone is replicated across all nodes in the cluster, allowing a container on Node 1 to resolve a service on Node 2.

2. The Docker DNS Server (127.0.0.11)

    Docker runs an Embedded DNS Server inside every container. If We look at /etc/resolv.conf inside a container, you will see the nameserver address is almost always 127.0.0.11.

# How the Embedded Server Handles Scopes:

    The embedded server acts as both an Authoritative and a Recursive server depending on the request:

    1. Internal Lookup (Authoritative): If Container A tries to ping container_b, the embedded DNS server checks its local network zone. If it finds a match, it returns the internal IP (e.g., 172.18.0.3).

    2. External Lookup (Recursive): If the container tries to reach google.com, the embedded server realizes it doesn't "own" that zone. It then forwards the request to the DNS servers configured on the host machine.

# Critical Technical Note

By default, the "Default Bridge" (the one named bridge) does not have a DNS zone. It does not support automatic service discovery by name‚Äîyou have to use IP addresses or --link

To get the benefits of a managed DNS zone and an embedded DNS server, you must create a User-Defined Network:

    docker network create my_app_zone
    docker run --network my_app_zone --name database ...

# Table to Understand DNS Zone & DNS Server

        | Component                 | Equivalent DNS Concept      |
        | ------------------------- | --------------------------- |
        | dockerd embedded DNS      | Authoritative DNS server    |
        | libnetwork endpoint store | Zone database               |
        | IPAM driver               | IP allocator                |
        | local-kv.db               | Persistent backend store    |
        | 127.0.0.11                | Per-network DNS entry point |

===================================================================================================
                        Docker DNS Service ‚Äì Deep Technical Explanation
===================================================================================================

Docker provides an embedded DNS server that enables container-to-container name resolution inside user-defined networks.

üß™ Lab 1 ‚Äî Default Bridge (Expected: Name Resolution Fails)

    Step 1 ‚Äî Run two Ubuntu containers

        docker run -dit --name ubuntu1 ubuntu:22.04
        docker run -dit --name ubuntu2 ubuntu:22.04

    Step 2 ‚Äî Install ping + dnsutils inside ubuntu1

        docker exec -it ubuntu1 bash
        apt update
        apt install -y iputils-ping dnsutils

    Step 3 ‚Äî Try resolving ubuntu2

        ping ubuntu2
        nslookup ubuntu2

Expected Result ‚ùå

    ping: ubuntu2: Name or service not known

DNS resolution fails

    Why? : Default bridge network does not provide automatic DNS-based service discovery.

üß™ Lab 2 ‚Äî User Defined Bridge (Expected: Works)

    Step 1 ‚Äî Create custom network

        docker network create test-net

    Step 2 ‚Äî Run containers inside network

        docker run -dit --name ubuntu3 --network test-net ubuntu:22.04
        docker run -dit --name ubuntu4 --network test-net ubuntu:22.04

    Step 3 ‚Äî Install tools in ubuntu3

        docker exec -it ubuntu3 bash
        apt update
        apt install -y iputils-ping dnsutils

    Step 4 ‚Äî Check DNS resolver

        cat /etc/resolv.conf

        Expected:

            This confirms Docker embedded DNS.

            root@5c83dcc0c5ed:/#  cat /etc/resolv.conf
            # Generated by Docker Engine.
            # This file can be edited; Docker Engine will not make further changes once it
            # has been modified.

            nameserver 127.0.0.11
            search bbrouter
            options edns0 trust-ad ndots:0

            # Based on host file: '/etc/resolv.conf' (internal resolver)
            # ExtServers: [host(127.0.0.53)]
            # Overrides: []
            # Option ndots from: internal

# Docker Host {ExtServers : 127.0.0.53} refered here.

        vboxuser@admin:~$ cat /etc/resolv.conf
        # This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
        # Do not edit.
        #
        # This file might be symlinked as /etc/resolv.conf. If you're looking at
        # /etc/resolv.conf and seeing this text, you have followed the symlink.
        #
        # This is a dynamic resolv.conf file for connecting local clients to the
        # internal DNS stub resolver of systemd-resolved. This file lists all
        # configured search domains.
        #
        # Run "resolvectl status" to see details about the uplink DNS servers
        # currently in use.
        #
        # Third party programs should typically not access this file directly, but only
        # through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a
        # different way, replace this symlink by a static file or a different symlink.
        #
        # See man:systemd-resolved.service(8) for details about the supported modes of
        # operation for /etc/resolv.conf.

        nameserver 127.0.0.53
        options edns0 trust-ad
        search bbrouter

    Step 5 ‚Äî Test name resolution

        ping ubuntu4
        nslookup ubuntu4

    Expected:

        root@5c83dcc0c5ed:/# ping ubuntu4
        PING ubuntu4 (172.20.0.3) 56(84) bytes of data.
        64 bytes from ubuntu4.test-net (172.20.0.3): icmp_seq=1 ttl=64 time=1.74 ms
        64 bytes from ubuntu4.test-net (172.20.0.3): icmp_seq=2 ttl=64 time=0.202 ms
        64 bytes from ubuntu4.test-net (172.20.0.3): icmp_seq=3 ttl=64 time=0.231 ms
        64 bytes from ubuntu4.test-net (172.20.0.3): icmp_seq=4 ttl=64 time=0.101 ms
        ^C
        --- ubuntu4 ping statistics ---
        4 packets transmitted, 4 received, 0% packet loss, time 3284ms
        rtt min/avg/max/mdev = 0.101/0.569/1.742/0.678 ms

        root@5c83dcc0c5ed:/# nslookup ubuntu4
        Server:         127.0.0.11
        Address:        127.0.0.11#53

        Non-authoritative answer:
        Name:   ubuntu4
        Address: 172.20.0.3

        DNS server shown as 127.0.0.11

        ‚úî This proves embedded DNS is active.

üß™ Lab 3 ‚Äî Inspect Network Internals

    On host:

        docker network inspect test-net

    Observe:

        Containers

        IP addresses

        Endpoint IDs

        This is Docker‚Äôs internal endpoint store used by embedded DNS.

        "Containers": {
            "5c83dcc0c5ed613ac769e1f669270b1285a96318618909bfeee39688a5fbe639": {
                "Name": "ubuntu3",
                "EndpointID": "26d0823dbe38a0d856bd4df70561d21327243daf491b9dc048d72f6b56d8a40f",
                "MacAddress": "56:24:a7:1f:8b:d7",
                "IPv4Address": "172.20.0.2/16",
                "IPv6Address": ""
            },
            "b8b617536729c15d844740d739daf63a5ebdcf847d081af5b95f6f4c108819c0": {
                "Name": "ubuntu4",
                "EndpointID": "64147aeb9f58d4e192dd379644af1a75acbcac61c281015b6bae95ad1b94ff24",
                "MacAddress": "e2:3f:93:ff:2d:b9",
                "IPv4Address": "172.20.0.3/16",
                "IPv6Address": ""
            }
        },
        "Status": {
            "IPAM": {
                "Subnets": {
                    "172.20.0.0/16": {
                        "IPsInUse": 5,
                        "DynamicIPsAvailable": 65531
                    }
                }
            }
        }

üß™ Lab 4 ‚Äî IP Change Test (Important Behavior)

    Now test dynamic resolution.

    Step 1 ‚Äî Get ubuntu4 IP

        docker inspect ubuntu4 | grep IPAddress

        vboxuser@admin:~$ docker inspect ubuntu4 | grep IPAddress
        "IPAddress": "172.20.0.3",

    Step 2 ‚Äî Remove and recreate ubuntu4

        docker rm -f ubuntu4
        docker run -dit --name ubuntu4 --network test-net ubuntu:22.04

    Step 3 ‚Äî From ubuntu3

        ping ubuntu4

    ‚úî It still works even though IP changed.

        Why?

        Because Docker DNS dynamically resolves container name to current IP.

üß™ Lab 5 ‚Äî Network Isolation Proof

Create another network:

    docker network create isolated-net
    docker run -dit --name ubuntu5 --network isolated-net ubuntu:22.04

From ubuntu3:

    ping ubuntu5

Expected:

    ‚ùå Fails ‚Äî different network scope.

Docker DNS is network-scoped.

üß™ Optional ‚Äî DNS Traffic Capture (Advanced)

On host:

    tcpdump -i any port 53

Then inside container:

    nslookup ubuntu4

You‚Äôll see DNS queries intercepted locally (not sent externally).

============================================================================================================









